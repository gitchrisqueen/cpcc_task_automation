# Codecov Configuration for CPCC Task Automation
# Documentation: https://docs.codecov.com/docs/codecov-yaml

# Global settings
codecov:
  # Require CI to pass before processing coverage
  require_ci_to_pass: yes
  
  # Use master branch as the source of truth for YAML config
  # This prevents rogue branches from changing coverage rules
  strict_yaml_branch: master

  # Codecov will reject reports that are over 12 hours old according to the timestamp in the report. 
  # This is to prevent reports that may have been accidentally checked into
  # To disable this functionality please add the following
  max_report_age: off
  #max_report_age can be listed in hours '#h' (hours) or '#d' (days)

# Coverage analysis configuration
coverage:
  # Precision for coverage percentages (2 decimal places)
  precision: 2
  
  # Round coverage to nearest decimal
  round: down
  
  # Coverage range for color coding in UI
  range: "70...100"
  
  # Status checks configuration
  status:
    # PROJECT status: Track overall repository coverage
    # Set to INFORMATIONAL - won't block PRs but shows trend
    project:
      default:
        # Target: 80% overall project coverage
        target: 80%
        
        # Threshold: Allow up to 1% drop without failing
        # (Even though informational, this sets expectations)
        threshold: 1%
        
        # INFORMATIONAL MODE: This status will always pass
        # We want to see project coverage and drive it upward,
        # but not block PRs while repo is climbing from 49% â†’ 80%
        informational: true
        
        # Only evaluate on pull requests
        only_pulls: true
        
        # Paths to include in project coverage calculation
        paths:
          - "src/cqc_cpcc/"
    
    # PATCH status: Enforce coverage on NEW code in PRs
    # This is our PRIMARY enforcement gate
    patch:
      default:
        # Target: 80% coverage on all new/modified code
        target: 80%
        
        # Threshold: 0% - no drops allowed for new code
        # New code must meet the 80% bar
        threshold: 0%
        
        # Only evaluate on pull requests
        only_pulls: true
        
        # Fail if coverage upload is missing
        # This prevents bypassing the gate by not uploading coverage
        if_not_found: failure
        
        # Paths to include in patch coverage calculation
        paths:
          - "src/cqc_cpcc/"

# Comment configuration for PR feedback
comment:
  # Post coverage summary as PR comment
  # Include component information in PR comments
  layout: "condensed_header, condensed_files, condensed_footer, components"
  
  # Show both patch and project status in comment
  behavior: default
  
  # Require changes to post new comment
  require_changes: false

# Ignore patterns - exclude files from coverage analysis
# These match the patterns in pyproject.toml [tool.coverage.run] omit
ignore:
  - "tests/**/*"
  - "src/cqc_cpcc/utilities/AI/llm_deprecated/**/*"
  - "src/cqc_streamlit_app/pages/**/*"
  - "**/__pycache__/**"
  - "**/*.pyc"
  - "**/conftest.py"

# Flag configuration for different test types
# We upload coverage separately for unit, integration, and e2e tests
flags:
  unit:
    # Coverage from unit tests
    paths:
      - "src/cqc_cpcc/"
    # Join with other flags if they exist
    carryforward: true
  
  integration:
    # Coverage from integration tests (backend only, no UI)
    paths:
      - "src/cqc_cpcc/"
    # Join with other flags
    carryforward: true
  
  e2e:
    # Coverage from end-to-end tests (includes Streamlit UI)
    # E2E tests exercise both backend and frontend code
    paths:
      - "src/cqc_cpcc/"
      - "src/cqc_streamlit_app/"
    # Join with other flags
    carryforward: true

# Component configuration for categorizing coverage by logical areas
# Components provide virtual filters to isolate coverage data
component_management:
  default_rules:
    # Default: all components have project status with 80% target
    statuses:
      - type: project
        target: 80%
        threshold: 1%
        only_pulls: true
  
  individual_components:
    # Core automation modules - web scraping and data collection
    - component_id: core_automation
      name: Core Automation
      paths:
        - "src/cqc_cpcc/brightspace.py"
        - "src/cqc_cpcc/my_colleges.py"
        - "src/cqc_cpcc/attendance.py"
        - "src/cqc_cpcc/find_student.py"
      statuses:
        - type: project
          target: 80%
        - type: patch
          target: 80%
    
    # AI/LLM functionality - OpenAI, OpenRouter, prompts
    - component_id: ai_llm
      name: AI/LLM
      paths:
        - "src/cqc_cpcc/utilities/AI/**"
      statuses:
        - type: project
          target: 80%
        - type: patch
          target: 80%
    
    # Rubric grading system - models, config, scoring
    - component_id: rubric_grading
      name: Rubric Grading
      paths:
        - "src/cqc_cpcc/rubric_*.py"
        - "src/cqc_cpcc/scoring/**"
      statuses:
        - type: project
          target: 90%  # Higher standard for critical grading logic
        - type: patch
          target: 90%
    
    # Exam and project grading
    - component_id: exam_grading
      name: Exam & Project Grading
      paths:
        - "src/cqc_cpcc/exam_review.py"
        - "src/cqc_cpcc/project_feedback.py"
        - "src/cqc_cpcc/error_*.py"
      statuses:
        - type: project
          target: 80%
        - type: patch
          target: 80%
    
    # Feedback and document generation
    - component_id: feedback_generation
      name: Feedback Generation
      paths:
        - "src/cqc_cpcc/feedback_doc_generator.py"
        - "src/cqc_cpcc/student_feedback_builder.py"
      statuses:
        - type: project
          target: 95%  # High coverage for student-facing output
        - type: patch
          target: 95%
    
    # Utilities - general helper functions
    - component_id: utilities
      name: Utilities
      paths:
        - "src/cqc_cpcc/utilities/utils.py"
        - "src/cqc_cpcc/utilities/date.py"
        - "src/cqc_cpcc/utilities/logger.py"
        - "src/cqc_cpcc/utilities/selenium_util.py"
        - "src/cqc_cpcc/utilities/pdf_utils.py"
        - "src/cqc_cpcc/utilities/zip_grading_utils.py"
      statuses:
        - type: project
          target: 80%
        - type: patch
          target: 80%
    
    # Streamlit UI - user interface components
    - component_id: streamlit_ui
      name: Streamlit UI
      paths:
        - "src/cqc_streamlit_app/**"
      # UI has lower coverage requirement (tested via E2E)
      statuses:
        - type: project
          target: 30%
          informational: true
